version: '3.8'

services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    networks:
      - proxy
    volumes:
      - jellyfin-config:/config
      - jellyfin-cache:/cache
      # Media directories (read-only to prevent accidental deletion)
      - /home/gmc/Media/Movies:/media/movies:ro
      - /home/gmc/Media/TVShows:/media/tvshows:ro
      - /home/gmc/Media/Music:/media/music:ro
      - /home/gmc/Media/Videos:/media/videos:ro
    environment:
      - TZ=${TZ}
      - JELLYFIN_PublishedServerUrl=https://jellyfin.${DOMAIN}
    labels:
      - "traefik.enable=true"
      # HTTP router (redirect to HTTPS)
      - "traefik.http.routers.jellyfin.entrypoints=http"
      - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.${DOMAIN}`)"
      - "traefik.http.routers.jellyfin.middlewares=jellyfin-https-redirect"
      # HTTPS router
      - "traefik.http.routers.jellyfin-secure.entrypoints=https"
      - "traefik.http.routers.jellyfin-secure.rule=Host(`jellyfin.${DOMAIN}`)"
      - "traefik.http.routers.jellyfin-secure.tls=true"
      - "traefik.http.routers.jellyfin-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.jellyfin-secure.service=jellyfin"
      # Middleware & Service
      - "traefik.http.middlewares.jellyfin-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
      - "traefik.docker.network=proxy"
    # Uncomment for hardware acceleration (NVIDIA):
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

volumes:
  jellyfin-config:
  jellyfin-cache:

networks:
  proxy:
    external: true
